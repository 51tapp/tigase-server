[[eventbus]]
Distributed Eventbus
===================
:author: Bartosz Ma≈Çkowski
:date: 2015-10-07 8:57
:version: v1.0 October 2015

:toc:
:numbered:
:website: http://www.tigase.org

Eventbus is component to distribute events among listeners: other components or
clients.

How it works
------------

Eventbus is based on limited http://www.xmpp.org/extensions/xep-0060.html[PubSub]
specification. Events are delivered to subscriber as normal PubSub notification.

Each component or client may subscribe for specific type of event.
Only components on cluster nodes are allowed to publish events.

Event in Eventbus is identified by two elements: name of event and namespace:
[source, xml]
-------
<EventName xmlns="tigase:demo">
  <sample_value>1</sample_value>
</EventName>
-------
Where event name is `EventName` and namespace is `tigase:demo`.

Listeners may subscribe for specific event or for all events with specific
namespace. Because in pubsub exists only single name of node, we have to add a
way to conversion event name and namespace to node name:
[source]
-------
nodename := eventname + "|" + namespace
-------

So for example to subscribe `<EventName xmlns="tigase:demo">`, node must be:
`EventName|tigase:demo`. In case of subscribing for all events with specific
namespace, use asterisk (`*`) instead of event name: `*|tigase:demo`.

[NOTE]
===============================
*Subscriptions are not persistent!*

After restart Tigase XMPP Server all clients (what are not cluster members,
for example Psi of administrator) must renew their subscriptions.

Inside cluster renewing is done automatically by Eventbus.
===============================



Subscribe to event
^^^^^^^^^^^^^^^^^^

Sample subscription request and server response in case of subscribing for event
`EventName` with namespace `tigase:demo`.

.Subscribing to specific event
[source, xml]
-------
<iq type='set'
    from='francisco@denmark.lit/barracks'
    to='eventbus.shakespeare.lit'
    id='sub1'>
  <pubsub xmlns='http://jabber.org/protocol/pubsub'>
    <subscribe
        node='EventName|tigase:demo'
        jid='francisco@denmark.lit'/>
  </pubsub>
</iq>
-------

.Success case
[source, xml]
-------
<iq type='result'
    from='eventbus.shakespeare.lit'
    to='francisco@denmark.lit/barracks'
    id='sub1'>
  <pubsub xmlns='http://jabber.org/protocol/pubsub'>
    <subscription
        node='EventName|tigase:demo'
        jid='francisco@denmark.lit'
        subscription='subscribed'/>
  </pubsub>
</iq>
-------

Sample subscription request and server response in case of subscribing for all
events with namespace `tigase:demo`.

.Subscribing to all events of name space
[source, xml]
-------
<iq type='set'
    from='francisco@denmark.lit/barracks'
    to='eventbus.shakespeare.lit'
    id='sub1'>
  <pubsub xmlns='http://jabber.org/protocol/pubsub'>
    <subscribe
        node='*|tigase:demo'
        jid='francisco@denmark.lit'/>
  </pubsub>
</iq>
-------

.Success case
[source, xml]
-------
<iq type='result'
    from='eventbus.shakespeare.lit'
    to='francisco@denmark.lit/barracks'
    id='sub1'>
  <pubsub xmlns='http://jabber.org/protocol/pubsub'>
    <subscription
        node='*|tigase:demo'
        jid='francisco@denmark.lit'
        subscription='subscribed'/>
  </pubsub>
</iq>
-------

Notification
^^^^^^^^^^^^

Sample notification from Eventbus:

.Sample notification
[source, xml]
-------
<message from='eventbus.shakespeare.lit' to='francisco@denmark.lit' id='foo'>
  <event xmlns='http://jabber.org/protocol/pubsub#event'>
    <items node='EventName|tigase:demo'>
      <item>
        <EventName xmlns="tigase:demo" eventSource="samplecomponent.shakespeare.lit'" eventTimestamp="1444216850">
          <sample_value>1</sample_value>
        </EventName>
      </item>
    </items>
  </event>
</message>
-------

[NOTE]
===============================
If client subscribed node `*|tigase:demo` then events will not be sent from
node `*|tigase:demo`, but from *real* node
(in this case: `EventName|tigase:demo`).
===============================

Setup
-----
Enable Eventbus by add following lines in init.properties:
[source, bash]
-------
--comp-name-1 = eventbus
--comp-class-1 = tigase.disteventbus.component.EventBusComponent
-------
As with any component, don't forget to keep the numbering sequential and one
number for each component.

Configuration
-------------

init.properties
^^^^^^^^^^^^^^^

To define list of JIDs allowed to subscribe for events:
[source, bash]
-----
eventbus/allowed-subscribers=francisco@denmark.lit,bernardo@denmark.lit
-----
